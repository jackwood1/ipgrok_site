<!DOCTYPE html>
<html>
<head>
    <title>Test S3 Speed Test Files</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>S3 Speed Test File Validator</h1>
    <p>This page tests if your S3 bucket is properly configured for speed tests.</p>
    
    <button onclick="testDownload()">Test Download (10MB)</button>
    <button onclick="testCORS()">Test CORS Headers</button>
    <button onclick="testFullSpeed()">Full Speed Test</button>
    
    <div id="results"></div>

    <script>
        const S3_URL = 'https://download-test-files-ipgrok.s3.us-east-2.amazonaws.com/50MB.test';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
        }
        
        async function testCORS() {
            log('Testing CORS configuration...');
            try {
                const response = await fetch(S3_URL, {
                    method: 'HEAD',
                    cache: 'no-store'
                });
                
                log(`✅ CORS Test Passed!
<pre>
Status: ${response.status}
CORS Origin: ${response.headers.get('Access-Control-Allow-Origin') || 'Not set'}
Content-Length: ${response.headers.get('Content-Length')} bytes
Content-Type: ${response.headers.get('Content-Type')}
</pre>`, 'success');
            } catch (error) {
                log(`❌ CORS Test Failed: ${error.message}
<pre>${error.stack}</pre>`, 'error');
            }
        }
        
        async function testDownload() {
            log('Testing 10MB download...');
            try {
                const start = performance.now();
                let receivedBytes = 0;
                
                const response = await fetch(S3_URL + '?t=' + Date.now(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const targetBytes = 10 * 1024 * 1024; // 10MB
                
                while (receivedBytes < targetBytes) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    receivedBytes += value.length;
                }
                
                const end = performance.now();
                const timeSec = (end - start) / 1000;
                const megabits = (receivedBytes * 8) / 1000000;
                const speedMbps = (megabits / timeSec).toFixed(2);
                
                log(`✅ Download Test Passed!
<pre>
Downloaded: ${(receivedBytes / (1024 * 1024)).toFixed(2)} MB
Time: ${timeSec.toFixed(2)} seconds
Speed: ${speedMbps} Mbps
</pre>`, 'success');
            } catch (error) {
                log(`❌ Download Test Failed: ${error.message}`, 'error');
            }
        }
        
        async function testFullSpeed() {
            log('Running full speed test (50MB)...');
            try {
                const start = performance.now();
                
                const response = await fetch(S3_URL + '?t=' + Date.now(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.arrayBuffer();
                const end = performance.now();
                
                const timeSec = (end - start) / 1000;
                const megabits = (data.byteLength * 8) / 1000000;
                const speedMbps = (megabits / timeSec).toFixed(2);
                
                log(`✅ Full Speed Test Passed!
<pre>
Downloaded: ${(data.byteLength / (1024 * 1024)).toFixed(2)} MB
Time: ${timeSec.toFixed(2)} seconds
Speed: ${speedMbps} Mbps
</pre>`, 'success');
            } catch (error) {
                log(`❌ Full Speed Test Failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-run CORS test on load
        window.addEventListener('load', () => {
            setTimeout(testCORS, 500);
        });
    </script>
</body>
</html>

